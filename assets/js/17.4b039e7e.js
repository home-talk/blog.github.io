(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{496:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"一、安装工具，dotnet-ef"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、安装工具，dotnet-ef"}},[s._v("#")]),s._v(" 一、安装工具，"),a("code",[s._v("dotnet-ef")])]),s._v(" "),a("p",[s._v("安裝")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("dotnet tool "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --global dotnet-ef\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("指定版本安裝")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("dotnet tool "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --global dotnet-ef --version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.0")]),s._v(".0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("卸载 dotnet-ef")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("dotnet tool uninstall -g dotnet-ef\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"二、安装数据库依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、安装数据库依赖"}},[s._v("#")]),s._v(" 二、安装数据库依赖")]),s._v(" "),a("p",[s._v("1、必须添加依赖"),a("code",[s._v("Microsoft.EntityFrameworkCore.Design")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("dotnet "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" package Microsoft.EntityFrameworkCore.Design\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("2、添加数据库驱动")]),s._v(" "),a("p",[s._v("不建议使用 "),a("code",[s._v("MySql.Data.EntityFrameworkCore")]),s._v("，因为此驱动只支持 MySQL，并且通过 EFCore DBFirst 生成的 Model 数据类型不全，如时间、Guid 都无法识别。")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("MySql.Data.EntityFrameworkCore\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("or")]),s._v(" "),a("p",[s._v("建议使用此驱动，不仅支持 MySQL,还支持 MariaDB。而且使用 EFCore DBFirst 可以识别所有的字段类型。")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("Pomelo.EntityFrameworkCore.MySql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("a",{attrs:{href:"https://docs.microsoft.com/en-us/ef/core/providers/?tabs=dotnet-core-cli",target:"_blank",rel:"noopener noreferrer"}},[s._v("微软官方说明"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"三、ef-core-从数据库生成代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、ef-core-从数据库生成代码"}},[s._v("#")]),s._v(" 三、EF Core 从数据库生成代码")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://docs.microsoft.com/zh-tw/ef/core/cli/dotnet",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方链接"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("安装了驱动"),a("code",[s._v("MySql.Data.EntityFrameworkCore")]),s._v("使用此命令")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("dotnet ef dbcontext scaffold "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server=localhost;port=3306;user=root;password=123456;database=DBName"')]),s._v(" MySql.Data.EntityFrameworkCore -o DBName -f\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("or")]),s._v(" "),a("p",[s._v("安装了驱动"),a("code",[s._v("Pomelo.EntityFrameworkCore.MySql")]),s._v("使用此命令")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("dotnet ef dbcontext scaffold "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server=localhost;port=3306;user=root;password=123456;database=DBName"')]),s._v(" Pomelo.EntityFrameworkCore.Mysql -f -o Models\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("创建 MySQL 数据库命令")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("create database name character "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" utf8mb4 collate utf8mb4_general_ci"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"四、将生成的代码复制到对应的代码层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、将生成的代码复制到对应的代码层"}},[s._v("#")]),s._v(" 四、将生成的代码复制到对应的代码层")]),s._v(" "),a("p",[s._v("1、将实体类复制到 Do 层\n2、将 Context 复制到仓储（Repository）层，并且做如下修改\n首先，删除如下代码：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("        protected override void OnConfiguring"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("DbContextOptionsBuilder optionsBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("optionsBuilder.IsConfigured"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#warning To protect potentially sensitive information in your connection string, you should move it out of source code. See http://go.microsoft.com/fwlink/?LinkId=723263 for guidance on storing connection strings.")]),s._v("\n                optionsBuilder.UseMySql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server=localhost;port=3306;user=root;password=123456;database=secmon"')]),s._v(", x "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" x.ServerVersion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8.0.17-mysql"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("其次，在 Extensions 层创建 ServiceExtensions： "),a("code",[s._v("DbSetup")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("    public static class DbSetup\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        public static void AddDbSetup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("this IServiceCollection services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("services "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" throw new ArgumentNullException"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nameof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            // services.AddScoped"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("SecMonContext"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" //如果数据库链接字符串写在SecMonContext，则使用此注入方式\n\n            services.AddDbContext"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("SecMonContext"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("options "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                options.UseMySql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server=localhost;port=3306;user=root;password=123456;database=secmon"')]),s._v(",\n                                 x "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" x.ServerVersion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8.0.17-mysql"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h2",{attrs:{id:"五、创建-httpcontextsetup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、创建-httpcontextsetup"}},[s._v("#")]),s._v(" 五、创建 HttpContextSetup")]),s._v(" "),a("p",[s._v("在 Extensions 层创建 ServiceExtensions： "),a("code",[s._v("HttpContextSetup")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("    public static class HttpContextSetup\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        public static void AddHttpContextSetup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("this IServiceCollection services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("services "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" throw new ArgumentNullException"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nameof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            services.AddSingleton"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("IHttpContextAccessor, HttpContextAccessor"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("在 Startup 中使用"),a("code",[s._v("AddDbSetup")]),s._v(" 和 "),a("code",[s._v("AddHttpContextAccessor")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("  services.AddDbSetup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  services.AddHttpContextAccessor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);