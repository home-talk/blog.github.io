(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{498:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"一、创建类库-extensions，并且安装-autofac-依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、创建类库-extensions，并且安装-autofac-依赖"}},[s._v("#")]),s._v(" 一、创建类库 Extensions，并且安装 Autofac 依赖")]),s._v(" "),a("p",[s._v("安裝两个 Nugget 包："),a("code",[s._v("Autofac.Extensions.DependencyInjection")]),s._v(" 和 "),a("code",[s._v("Autofac.Extras.DynamicProxy")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ItemGroup"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("PackageReference "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Include")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Autofac.Extensions.DependencyInjection"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Version")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7.1.0"')]),s._v("/"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("PackageReference "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Include")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Autofac.Extras.DynamicProxy"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Version")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6.0.0"')]),s._v("/"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/ItemGroup"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"二、封装-autofacmoduleregister-cs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、封装-autofacmoduleregister-cs"}},[s._v("#")]),s._v(" 二、封装 AutofacModuleRegister.cs")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("    public class AutofacModuleRegister "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Autofac.Module\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        // private static "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("readonly")]),s._v(" ILog log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" LogManager.GetLogger"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("typeof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("AutofacModuleRegister"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        protected override void Load"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ContainerBuilder builder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            var basePath "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" AppContext.BaseDirectory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#region 带有接口层的服务注入")]),s._v("\n            var servicesDllFile "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Path.Combine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("basePath, "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Services.dll"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            var repositoryDllFile "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Path.Combine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("basePath, "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Repository.dll"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("File.Exists"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("servicesDllFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" File.Exists"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("repositoryDllFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                var msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Repository.dll和service.dll 丢失，因为项目解耦了，所以需要先F6编译，再F5运行，请检查 bin 文件夹"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                // log.Error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                throw new Exception"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n            // builder.RegisterGeneric"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("typeof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BaseRepository"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(".As"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("typeof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("IBaseRepository"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(".InstancePerDependency"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("//注册仓储\n            builder.RegisterGeneric"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("typeof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BaseRepository"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(","),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(".As"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("typeof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("IBaseRepository"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(","),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(".InstancePerDependency"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("//注册仓储\n\n            // 获取 Service.dll 程序集服务，并注册\n            var assemblyServices "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Assembly.LoadFrom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("servicesDllFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            builder.RegisterAssemblyTypes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("assemblyServices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                      .AsImplementedInterfaces"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                      .InstancePerDependency"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            .EnableInterfaceInterceptors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("//引用Autofac.Extras.DynamicProxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            //.InterceptedBy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cacheType.ToArray"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("//允许将拦截器服务的列表分配给注册。\n\n            // 获取 Repository.dll 程序集服务，并注册\n            var assemblyRepository "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Assembly.LoadFrom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("repositoryDllFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            builder.RegisterAssemblyTypes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("assemblyRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                   .AsImplementedInterfaces"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                   .InstancePerDependency"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#endregion")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br")])]),a("h2",{attrs:{id:"三、在-program-中-autofac-服务工厂"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、在-program-中-autofac-服务工厂"}},[s._v("#")]),s._v(" 三、在 Program 中 Autofac 服务工厂")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("        public static IHostBuilder CreateHostBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n            Host.CreateDefaultBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            .UseServiceProviderFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("new AutofacServiceProviderFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n            .ConfigureWebHostDefaults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("webBuilder "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                webBuilder.UseStartup"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Startup"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"四、在-startup-中"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、在-startup-中"}},[s._v("#")]),s._v(" 四、在 Startup 中")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("        // 注意，要在 Program 中 添加 AutofacServiceProviderFactory\n        public void ConfigureContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ContainerBuilder builder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            builder.RegisterModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("new AutofacModuleRegister"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);